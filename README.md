# Student Helper Telegram Bot
## О проекте

**Student Helper Telegram Bot** - это многофункциональный телеграм-бот для образовательных целей, который предоставляет студентам и преподавателям инструменты для управления учебным процессом.

## Основные функции

### Аутентификация и регистрация
- Авторизация по email/password
- Регистрация новых пользователей
- Ролевая модель (студент/администратор)

### Управление публикациями
- Создание публикаций (домашние задания, решения, материалы)
- Просмотр всех публикаций
- Поиск публикаций по ID
- Разделение по типам: homework, solution, material

### ИИ-помощник
- Помощь по различным предметам:
  - Математика (math)
  - Программирование (programming)
  - Лекции (lectures)
  - Общие вопросы (general)
- Контекстные ответы
- История диалогов

### Управление лекциями
- Поиск лекций по предмету
- Добавление новых лекций (только для администраторов)
- Хранение внешних ссылок на учебные материалы

### Управление группами (администраторы)
- Создание учебных групп
- Назначение пользователей в группы

## Архитектура проекта

### Структура проекта
```
StudentHelperTelegramBot/
├── Configuration/          # Конфигурация бота и API
├── Handlers/              # Обработчики сообщений и команд
├── Models/                # Модели данных
├── Services/              # Сервисы (API, состояние, очистка)
└── Program.cs             # Точка входа
```

### Ключевые компоненты

1. **BotService** - Основной сервис бота, управляет получением сообщений
2. **MessageHandler** - Обработчик входящих сообщений и состояний
3. **CommandHandler** - Обработчик команд
4. **ApiService** - Клиент для взаимодействия с API
5. **UserStateService** - Управление состояниями пользователей
6. **MessageCleanupService** - Очистка сообщений

## Быстрый старт

### Предварительные требования
- .NET 6.0 или выше
- Telegram Bot Token (получить у @BotFather)
- Рабочий API сервер Student Helper

### Настройка

1. **Клонирование репозитория**
```bash
git clone <repository-url>
cd StudentHelperTelegramBot
```

2. **Настройка конфигурации**
Создайте файл `appsettings.json` в корне проекта:
```json
{
  "TelegramBot": {
    "Token": "ВАШ_TELEGRAM_BOT_TOKEN"
  },
  "ApiSettings": {
    "BaseUrl": "https://ваш-api-сервер/api"
  }
}
```

3. **Запуск приложения**
```bash
dotnet run
```

## Команды бота

### Основные команды
- `/start` - Главное меню
- `/status` - Статус бота и пользователя
- `/logout` - Выход из системы

### Команды для публикаций
- `/publication {id}` - Просмотр конкретной публикации
- `Публикации` - Меню управления публикациями
- `Создать публикацию` - Создание новой публикации
- `Мои публикации` - Просмотр всех публикаций

### Команды ИИ-помощника
- `ИИ помощник` - Выбор категории для ИИ
- Доступные категории: math, programming, lectures, general

### Команды для лекций
- `Лекции` - Поиск лекций по предмету
- `Добавить лекцию` - Добавление новой лекции (администраторы)

### Административные команды
- `Создать группу` - Создание учебной группы
- `Общая информация` - Информация о возможностях бота

## Конфигурация API

### Требуемые конечные точки API

#### Аутентификация
- `POST /api/helper/auth` - Авторизация
- `POST /api/helper/reg` - Регистрация

#### Публикации
- `GET /api/helper/publications` - Получение всех публикаций
- `GET /api/helper/publications/{id}` - Получение конкретной публикации
- `POST /api/helper/publications` - Создание публикации

#### Лекции
- `GET /api/helper/lectures/{subject}` - Получение лекций по предмету
- `POST /api/helper/admin/lecture/add` - Добавление лекции

#### Группы
- `POST /api/helper/admin/group/add` - Создание группы

#### ИИ-помощник
- `POST /api/helper/ai/chat` - Отправка сообщения ИИ

## Модели данных

### UserSession
```csharp
public class UserSession
{
    public long ChatId { get; set; }
    public UserState State { get; set; }
    public Dictionary<string, string> Data { get; set; }
    public DateTime LastActivity { get; set; }
    public List<int> MessagesToDelete { get; set; }
}
```

### Состояния пользователя (UserState)
- `None` - Нет активного состояния
- `WaitingForEmail` - Ожидание email для входа
- `WaitingForPassword` - Ожидание пароля
- `WaitingForPublicationTitle` - Ожидание заголовка публикации
- И другие состояния для различных операций

## Разработка

### Добавление новой функции

1. **Добавьте состояние в UserState enum**
2. **Реализуйте обработчик в MessageHandler**
3. **Добавьте обработку команды в CommandHandler**
4. **При необходимости добавьте API метод в ApiService**

### Пример добавления новой команды:
```csharp
// В CommandHandler.cs
case "Новая команда":
    await HandleNewCommand(botClient, chatId, cancellationToken);
    return true;

// В MessageHandler.cs
private async Task HandleNewCommand(long chatId, string text, CancellationToken ct)
{
    // Логика обработки
}
```

## Управление состояниями

Бот использует систему состояний для управления многошаговыми операциями:
- Состояния хранятся в памяти с использованием ConcurrentDictionary
- Автоматическая очистка неактивных сессий (каждые 30 минут)
- Максимальное время бездействия: 2 часа

## Безопасность

- JWT токены для аутентификации API
- Очистка конфиденциальных сообщений (пароли, email)
- Проверка ролей для административных функций
- Валидация входных данных

## Очистка сообщений

Система автоматически удаляет:
- Сообщения с паролями и email
- Промежуточные сообщения в многошаговых процессах
- Обрабатывает ошибки удаления безопасно

## Отладка и логирование

### Уровни логирования:
- Консольный вывод всех входящих сообщений
- Логирование ответов API
- Обработка и логирование исключений

### Просмотр логов:
```csharp
Console.WriteLine($"Received: {text} from {message.From?.Username}");
Console.WriteLine($"API response: {response.StatusCode} - {responseContent}");
```

## Поддержка

### Проблемы и вопросы:
1. Проверьте правильность конфигурации токена и URL API
2. Убедитесь, что API сервер доступен и работает
3. Проверьте логи бота для диагностики ошибок

### Известные ограничения:
- Telegram ограничивает длину сообщений до 4096 символов
- Некоторые операции требуют авторизации
- Административные функции доступны только пользователям с ролью "admin"

## Авторы и контрибьюторы

Камаев Данияр, Ufa-Dynamics

---

**Примечание**: Этот бот является частью экосистемы Student Helper. Для полной функциональности требуется работающий API сервер Student Helper с соответствующими Endpoint-ами.
